import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go
from datetime import datetime, timedelta
import time

# =========================
# BASIC CONFIG
# =========================

st.set_page_config(
    page_title="üöÄ AI Stock Oracle Pro",
    page_icon="üìà",
    layout="wide",
    initial_sidebar_state="expanded",
)

# =========================
# SAFE DATA + PREDICTION LAYER
# (NO EXTERNAL API, ALWAYS WORKS)
# =========================

@st.cache_data(ttl=300)
def generate_synthetic_history(ticker: str, days: int = 180) -> pd.DataFrame:
    """
    Creates a smooth, realistic OHLCV series so the app always works,
    even offline. Later you can replace this with real data.
    """
    rng = np.random.default_rng(abs(hash(ticker)) % (2**32 - 1))
    dates = pd.bdate_range(end=datetime.today(), periods=days)

    base_price = rng.uniform(80, 400)
    daily_moves = rng.normal(loc=0.0005, scale=0.02, size=len(dates))
    close_prices = base_price * np.cumprod(1 + daily_moves)

    df = pd.DataFrame(index=dates)
    df["Open"] = close_prices * (1 + rng.normal(0, 0.005, size=len(dates)))
    df["High"] = df["Open"] * (1 + np.abs(rng.normal(0.01, 0.01, size=len(dates))))
    df["Low"] = df["Open"] * (1 - np.abs(rng.normal(0.01, 0.01, size=len(dates))))
    df["Close"] = close_prices
    df["Volume"] = rng.integers(2e5, 5e6, size=len(dates))
    return df


class PredictionResult:
    """
    Stable, realistic prediction wrapper.
    Swap internals with your trained model later.
    """

    def __init__(self, ticker: str, df: pd.DataFrame):
        self.ticker = ticker
        self.df = df

        last_close = float(df["Close"].iloc[-1])

        rng = np.random.default_rng(abs(hash(ticker + "pred")) % (2**32 - 1))

        tomorrow_factor = 1 + rng.normal(0.003, 0.02)
        week_factor = 1 + rng.normal(0.015, 0.06)

        self._current_price = last_close
        self._tomorrow_price = last_close * tomorrow_factor
        self._week_price = last_close * week_factor

        self._prob_tomorrow_up = float(np.clip(rng.normal(0.57, 0.12), 0.05, 0.95))
        self._prob_week_up = float(np.clip(rng.normal(0.60, 0.15), 0.05, 0.95))
        self._confidence = float(np.clip(rng.normal(0.8, 0.08), 0.5, 0.99))

        self._expected_return_tomorrow = (
            self._tomorrow_price - last_close
        ) / last_close
        self._expected_return_week = (self._week_price - last_close) / last_close

        if self._prob_tomorrow_up > 0.62 and self._prob_week_up > 0.62:
            self._recommendation = "STRONG BUY"
        elif self._prob_tomorrow_up > 0.54 and self._prob_week_up > 0.54:
            self._recommendation = "BUY"
        elif self._prob_tomorrow_up < 0.40 and self._prob_week_up < 0.42:
            self._recommendation = "SELL"
        else:
            self._recommendation = "HOLD"

    # getters ‚Äì these match what you wanted earlier
    def get_current_price(self): return self._current_price
    def get_tomorrow_price(self): return self._tomorrow_price
    def get_week_price(self): return self._week_price
    def get_recommendation(self): return self._recommendation
    def get_confidence(self): return self._confidence
    def get_prob_tomorrow_up(self): return self._prob_tomorrow_up
    def get_prob_week_up(self): return self._prob_week_up
    def get_expected_return_tomorrow(self): return self._expected_return_tomorrow
    def get_expected_return_week(self): return self._expected_return_week


def predict_for_symbol_safe(ticker: str) -> PredictionResult:
    """
    Main function to call from the UI.
    Currently uses synthetic history + synthetic predictions.
    Replace the internals with:
        df = your_real_loader(ticker)
        result = your_real_predictor(df or ticker)
    """
    df = generate_synthetic_history(ticker, days=240)
    return PredictionResult(ticker, df)


# =========================
# PREMIUM CSS
# =========================

st.markdown(
    """
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');

* { font-family: 'Inter', sans-serif; }

.main {
    background: linear-gradient(-45deg,#667eea,#764ba2,#f093fb,#f5576c,#4facfe);
    background-size: 400% 400%;
    animation: gradientShift 20s ease infinite;
}

@keyframes gradientShift {
  0% {background-position:0% 50%}
  50% {background-position:100% 50%}
  100% {background-position:0% 50%}
}

.block-container {
    background: rgba(255,255,255,0.93);
    border-radius: 30px;
    padding: 3rem;
    box-shadow: 0 25px 80px rgba(0,0,0,0.25);
    backdrop-filter: blur(22px);
    border: 1px solid rgba(255,255,255,0.3);
}

.hero {
    text-align: center;
    padding: 3.5rem 2rem;
    background: radial-gradient(circle at top left,#ffffff33,#667eea),
                radial-gradient(circle at bottom right,#ffffff22,#764ba2);
    border-radius: 25px;
    margin-bottom: 2.5rem;
    box-shadow: 0 20px 60px rgba(102,126,234,0.45);
}

.hero h1 {
    color: #fff;
    font-size: 3.6rem;
    font-weight: 800;
    margin: 0;
    text-shadow: 0 0 30px rgba(255,255,255,0.9);
}

.hero p {
    color: #fdfdfd;
    font-size: 1.24rem;
    margin-top: 0.8rem;
}

.premium-card {
    background: linear-gradient(145deg,#ffffffee,#f7f4ffdd);
    border-radius: 22px;
    padding: 1.8rem 1.7rem;
    box-shadow: 0 15px 38px rgba(0,0,0,0.12);
    border: 1px solid rgba(255,255,255,0.4);
    transition: all 0.3s ease;
}

.premium-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 25px 70px rgba(102,126,234,0.45);
}

.metric-card {
    background: linear-gradient(135deg,#667eea,#764ba2);
    border-radius: 20px;
    padding: 1.7rem 1.2rem;
    color: #fff;
    text-align: center;
    box-shadow: 0 18px 45px rgba(102,126,234,0.55);
}

.metric-label {
    font-size: 0.92rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    opacity: 0.9;
}

.metric-value {
    font-size: 2.7rem;
    font-weight: 800;
    margin-top: 0.6rem;
}

.rec-badge {
    display: inline-block;
    padding: 1.1rem 2.8rem;
    border-radius: 999px;
    font-size: 1.6rem;
    font-weight: 800;
    color: #fff;
    box-shadow: 0 18px 40px rgba(0,0,0,0.25);
}

.rec-buy  { background: linear-gradient(135deg,#00c853,#b2ff59); }
.rec-sell { background: linear-gradient(135deg,#ff1744,#ff9100); }
.rec-hold { background: linear-gradient(135deg,#ff6ec4,#7873f5); }

.info-box {
    background: linear-gradient(135deg,rgba(102,126,234,0.10),rgba(118,75,162,0.10));
    border-left: 4px solid #667eea;
    border-radius: 16px;
    padding: 1.1rem 1.3rem;
    margin-bottom: 1.2rem;
}

.chart-container {
    background: #ffffffee;
    border-radius: 22px;
    padding: 1.8rem 1.6rem;
    box-shadow: 0 15px 40px rgba(0,0,0,0.11);
    border: 1px solid rgba(255,255,255,0.6);
}

/* Buttons */
.stButton > button {
    background: linear-gradient(135deg,#667eea,#764ba2) !important;
    color:#fff !important;
    border-radius: 999px !important;
    padding: 0.9rem 2.5rem !important;
    font-weight: 700 !important;
    border: none !important;
    box-shadow:0 12px 30px rgba(102,126,234,0.55) !important;
}
.stButton > button:hover {
    transform: translateY(-2px);
}

/* Sidebar */
.css-1d391kg, .st-emotion-cache-1d391kg {
    background: linear-gradient(180deg,#1f2446,#14172b);
}
</style>
    """,
    unsafe_allow_html=True,
)

# =========================
# HERO
# =========================

st.markdown(
    """
<div class="hero">
  <h1>üöÄ AI Stock Oracle Pro</h1>
  <p>Premium UI ¬∑ Smooth Animations ¬∑ Always-Working Demo Predictions</p>
</div>
""",
    unsafe_allow_html=True,
)

# =========================
# SIDEBAR
# =========================

with st.sidebar:
    st.markdown("### üìà Stock Selection")
    tickers = [
        "AAPL",
        "MSFT",
        "GOOGL",
        "TSLA",
        "NVDA",
        "AMZN",
        "META",
        "NFLX",
        "ADBE",
        "INTC",
    ]
    ticker = st.selectbox("Choose stock", tickers, index=0)

    st.markdown("---")
    st.markdown(
        """
<div class="info-box">
  <strong>ü§ñ Model</strong><br>
  Frontend demo using synthetic but realistic prices.<br>
  Later plug in your trained model in <code>predict_for_symbol_safe()</code>.
</div>
""",
        unsafe_allow_html=True,
    )

    st.markdown(
        """
<div class="info-box">
  <strong>How to deploy</strong><br>
  1. Save as <code>app.py</code><br>
  2. Run <code>streamlit run app.py</code>
</div>
""",
        unsafe_allow_html=True,
    )

# =========================
# TABS
# =========================

tab_live, tab_data, tab_about = st.tabs(
    ["üîÆ Live Prediction", "üìä Market Data", "‚ÑπÔ∏è About"]
)

# =========================
# TAB 1 ‚Äì LIVE PREDICTION
# =========================

with tab_live:
    st.subheader(f"Predicting {ticker}")

    col_left, col_right = st.columns([2.3, 1.7])

    with col_left:
        btn = st.button("üöÄ GENERATE AI PREDICTION", use_container_width=True)
        if btn:
            with st.spinner("Running AI pipeline..."):
                prog = st.progress(0)
                steps = [
                    ("Preparing market sequence", 25),
                    ("Running neural network inference", 60),
                    ("Computing risk‚Äëadjusted metrics", 85),
                    ("Finalizing insights", 100),
                ]
                for msg, p in steps:
                    prog.progress(p)
                    time.sleep(0.35)
                prog.empty()

                # prediction
                result = predict_for_symbol_safe(ticker)

                curr = result.get_current_price()
                tmr = result.get_tomorrow_price()
                wk = result.get_week_price()

                st.success("Prediction complete")

                # metric cards
                st.markdown("#### üí∞ Price Overview")
                m1, m2, m3 = st.columns(3)

                with m1:
                    st.markdown(
                        f"""
<div class="metric-card">
  <div class="metric-label">Current</div>
  <div class="metric-value">${curr:.2f}</div>
</div>
""",
                        unsafe_allow_html=True,
                    )
                tmr_change = (tmr - curr) / curr * 100
                wk_change = (wk - curr) / curr * 100

                with m2:
                    sign = "‚ñ≤" if tmr_change >= 0 else "‚ñº"
                    st.markdown(
                        f"""
<div class="metric-card">
  <div class="metric-label">Tomorrow</div>
  <div class="metric-value">${tmr:.2f}</div>
  <div style="margin-top:0.4rem;font-size:1.1rem;">{sign} {tmr_change:.2f}%</div>
</div>
""",
                        unsafe_allow_html=True,
                    )
                with m3:
                    sign = "‚ñ≤" if wk_change >= 0 else "‚ñº"
                    st.markdown(
                        f"""
<div class="metric-card">
  <div class="metric-label">1‚ÄëWeek</div>
  <div class="metric-value">${wk:.2f}</div>
  <div style="margin-top:0.4rem;font-size:1.1rem;">{sign} {wk_change:.2f}%</div>
</div>
""",
                        unsafe_allow_html=True,
                    )

                # recommendation
                rec = result.get_recommendation()
                conf = result.get_confidence()
                if "BUY" in rec:
                    cls = "rec-buy"
                    emoji = "üü¢"
                elif "SELL" in rec:
                    cls = "rec-sell"
                    emoji = "üî¥"
                else:
                    cls = "rec-hold"
                    emoji = "üü°"

                st.markdown("#### üéØ Trading Signal")
                st.markdown(
                    f"""
<div class="premium-card" style="text-align:center;">
  <div class="rec-badge {cls}">{emoji} {rec}</div>
  <p style="margin-top:0.9rem;font-size:1.2rem;">
     Confidence: <strong>{conf:.1%}</strong>
  </p>
</div>
""",
                    unsafe_allow_html=True,
                )

                # detailed probabilities
                st.markdown("#### üìä Probability & Expected Returns")
                c1, c2 = st.columns(2)
                with c1:
                    p_up = result.get_prob_tomorrow_up()
                    st.markdown(
                        "<div class='premium-card'><strong>Tomorrow</strong>",
                        unsafe_allow_html=True,
                    )
                    st.metric("Up‚Äëmove probability", f"{p_up:.1%}")
                    st.metric(
                        "Expected return",
                        f"{result.get_expected_return_tomorrow():.2%}",
                    )
                    st.markdown("</div>", unsafe_allow_html=True)

                with c2:
                    p_up_w = result.get_prob_week_up()
                    st.markdown(
                        "<div class='premium-card'><strong>1‚ÄëWeek</strong>",
                        unsafe_allow_html=True,
                    )
                    st.metric("Up‚Äëmove probability", f"{p_up_w:.1%}")
                    st.metric(
                        "Expected return",
                        f"{result.get_expected_return_week():.2%}",
                    )
                    st.markdown("</div>", unsafe_allow_html=True)

                # forecast chart
                st.markdown("#### üìà Forecast Path")
                st.markdown('<div class="chart-container">', unsafe_allow_html=True)

                dates = [
                    datetime.now(),
                    datetime.now() + timedelta(days=1),
                    datetime.now() + timedelta(days=7),
                ]
                prices = [curr, tmr, wk]

                fig = go.Figure()
                fig.add_trace(
                    go.Scatter(
                        x=[dates[0]],
                        y=[prices[0]],
                        mode="markers+text",
                        name="Current",
                        marker=dict(size=18, color="#667eea", symbol="star"),
                        text=[f"${prices[0]:.2f}"],
                        textposition="top center",
                    )
                )
                fig.add_trace(
                    go.Scatter(
                        x=dates[:2],
                        y=prices[:2],
                        mode="lines+markers",
                        name="Tomorrow",
                        line=dict(color="#11c26d", width=4),
                        marker=dict(size=12),
                    )
                )
                fig.add_trace(
                    go.Scatter(
                        x=[dates[0], dates[2]],
                        y=[prices[0], prices[2]],
                        mode="lines+markers",
                        name="1‚ÄëWeek",
                        line=dict(color="#764ba2", width=4, dash="dash"),
                        marker=dict(size=12),
                    )
                )

                fig.update_layout(
                    height=420,
                    template="plotly_white",
                    xaxis_title="Date",
                    yaxis_title="Price",
                    legend=dict(orientation="h", x=0.5, xanchor="center", y=1.1),
                )
                st.plotly_chart(fig, use_container_width=True)
                st.markdown("</div>", unsafe_allow_html=True)

                st.info(
                    "This is a demo front‚Äëend. Integrate your trained model by "
                    "replacing the internals of `predict_for_symbol_safe()`."
                )

    with col_right:
        st.markdown(
            """
<div class="premium-card">
  <h4>‚ö° Quick Guide</h4>
  <ul>
    <li>Select any stock from the left sidebar.</li>
    <li>Press <b>Generate AI Prediction</b>.</li>
    <li>Review prices, probability and signal.</li>
  </ul>
</div>
""",
            unsafe_allow_html=True,
        )

# =========================
# TAB 2 ‚Äì MARKET DATA
# =========================

with tab_data:
    st.subheader(f"{ticker} synthetic market history")

    df_hist = generate_synthetic_history(ticker, days=240)

    st.markdown("#### üïØ Price & Volume")
    st.markdown('<div class="chart-container">', unsafe_allow_html=True)

    fig2 = go.Figure()
    fig2.add_trace(
        go.Candlestick(
            x=df_hist.index,
            open=df_hist["Open"],
            high=df_hist["High"],
            low=df_hist["Low"],
            close=df_hist["Close"],
            name="Price",
        )
    )
    fig2.update_layout(
        height=450,
        xaxis_title="Date",
        yaxis_title="Price",
        template="plotly_white",
        xaxis_rangeslider_visible=False,
    )
    st.plotly_chart(fig2, use_container_width=True)
    st.markdown("</div>", unsafe_allow_html=True)

    st.markdown("#### üìã Last 15 days")
    st.dataframe(
        df_hist[["Open", "High", "Low", "Close", "Volume"]]
        .tail(15)
        .style.format(
            {
                "Open": "{:.2f}",
                "High": "{:.2f}",
                "Low": "{:.2f}",
                "Close": "{:.2f}",
                "Volume": "{:,.0f}",
            }
        ),
        use_container_width=True,
    )

# =========================
# TAB 3 ‚Äì ABOUT
# =========================

with tab_about:
    st.subheader("About this demo")

    col_a, col_b = st.columns(2)
    with col_a:
        st.markdown(
            """
<div class="premium-card">
  <h4>Architecture</h4>
  <ul>
    <li>Frontend: Streamlit + custom CSS</li>
    <li>Charts: Plotly (interactive)</li>
    <li>Data: Synthetic OHLCV generator</li>
    <li>Model: Replaceable prediction wrapper</li>
  </ul>
</div>
""",
            unsafe_allow_html=True,
        )
    with col_b:
        st.markdown(
            """
<div class="premium-card">
  <h4>Plug in your ML model</h4>
  <p>
    Use this file as the UI shell. In <code>predict_for_symbol_safe()</code>,
    instead of generating synthetic predictions, call your own trained
    model and fill the fields of <code>PredictionResult</code>.
  </p>
</div>
""",
            unsafe_allow_html=True,
        )

st.markdown(
    """
<div style="text-align:center;margin-top:2.5rem;color:#777;">
  <b>Disclaimer:</b> Demo prices and predictions above are synthetic and for UI testing only.
</div>
""",
    unsafe_allow_html=True,
)
